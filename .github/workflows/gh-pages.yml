name: Deploy GitHub Finder to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ” Complete repository scan
        run: |
          echo "ğŸ“ Repository structure analysis:"
          echo "=================================="
          find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" | head -20
          echo ""
          echo "ğŸ“‚ Directory listing:"
          ls -la
          echo ""
          echo "ğŸ” Specific file checks:"
          if [ -f 'index.html' ]; then
            echo "Root index.html: âœ… EXISTS"
          else
            echo "Root index.html: âŒ MISSING"
          fi

          if [ -d 'html' ]; then
            echo "HTML folder: âœ… EXISTS"
          else
            echo "HTML folder: âŒ MISSING"
          fi

          if [ -d 'css' ]; then
            echo "CSS folder: âœ… EXISTS"
          else
            echo "CSS folder: âŒ MISSING"
          fi

          if [ -d 'js' ]; then
            echo "JS folder: âœ… EXISTS"
          else
            echo "JS folder: âŒ MISSING"
          fi

      - name: ğŸ“‚ Smart file detection and copying
        run: |
          echo "ğŸ—ï¸ Creating public directory..."
          mkdir -p public

          echo "ğŸ§  Smart file detection started..."

          # Find and copy HTML file
          HTML_FOUND=false

          if [ -f "index.html" ]; then
            cp index.html public/index.html
            echo "âœ… Found and copied: ROOT/index.html â†’ public/index.html"
            HTML_FOUND=true
          elif [ -f "html/index.html" ]; then
            cp html/index.html public/index.html
            echo "âœ… Found and copied: html/index.html â†’ public/index.html"
            HTML_FOUND=true
          else
            echo "âŒ No index.html found in root or html/ folder!"
          fi

          # Find and copy CSS file
          CSS_FOUND=false
          if [ -f "style.css" ]; then
            cp style.css public/style.css
            echo "âœ… Found and copied: ROOT/style.css â†’ public/style.css"
            CSS_FOUND=true
          elif [ -f "css/style.css" ]; then
            cp css/style.css public/style.css
            echo "âœ… Found and copied: css/style.css â†’ public/style.css"
            CSS_FOUND=true
          else
            echo "âš ï¸ No style.css found in root or css/ folder"
          fi

          # Find and copy JS file
          JS_FOUND=false
          if [ -f "app.js" ]; then
            cp app.js public/app.js
            echo "âœ… Found and copied: ROOT/app.js â†’ public/app.js"
            JS_FOUND=true
          elif [ -f "js/app.js" ]; then
            cp js/app.js public/app.js
            echo "âœ… Found and copied: js/app.js â†’ public/app.js"
            JS_FOUND=true
          else
            echo "âš ï¸ No app.js found in root or js/ folder"
          fi

          # Copy README
          if [ -f "README.md" ]; then
            cp README.md public/readme.md
            echo "âœ… Copied: README.md â†’ public/readme.md"
          fi

          # Create emergency HTML if needed
          if [ "$HTML_FOUND" = "false" ]; then
            echo "ğŸ’¥ CRITICAL ERROR: No HTML file found!"
            echo "ğŸ“ Creating emergency index.html..."
            cat > public/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>GitHub Finder - File Missing</title>
              <style>
                  body { 
                      font-family: Arial, sans-serif; 
                      text-align: center; 
                      padding: 50px; 
                      background: linear-gradient(135deg, #667eea, #764ba2);
                      color: white;
                      min-height: 100vh;
                      margin: 0;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      flex-direction: column;
                  }
                  .container {
                      background: rgba(255,255,255,0.1);
                      padding: 40px;
                      border-radius: 20px;
                      backdrop-filter: blur(10px);
                  }
                  .error { color: #ff6b6b; font-size: 1.2em; margin: 20px 0; }
                  .info { color: #4ecdc4; margin: 15px 0; }
                  .code { 
                      background: rgba(0,0,0,0.3); 
                      padding: 15px; 
                      border-radius: 10px; 
                      font-family: monospace;
                      margin: 20px 0;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ” GitHub Finder</h1>
                  <p class="error">âš ï¸ index.html íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                  <p class="info">ë‹¤ìŒ ìœ„ì¹˜ ì¤‘ í•˜ë‚˜ì— íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”:</p>
                  <div class="code">
                      ğŸ“ ì €ì¥ì†Œ ë£¨íŠ¸/index.html<br>
                      ğŸ“ ì €ì¥ì†Œ ë£¨íŠ¸/html/index.html
                  </div>
                  <p class="info">íŒŒì¼ ì—…ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ë°°í¬ë©ë‹ˆë‹¤.</p>
              </div>
          </body>
          </html>
          HTMLEOF
            echo "ğŸ†˜ Emergency index.html created"
          fi

      - name: ğŸ“‹ Final verification
        run: |
          echo "ğŸ—‚ï¸ Final public directory contents:"
          ls -la public/
          echo ""
          echo "ğŸ“Š File size report:"
          for file in public/*; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              filename=$(basename "$file")
              echo "ğŸ“„ $filename: $size bytes"
            fi
          done
          echo ""
          echo "ğŸ” index.html preview (first 5 lines):"
          head -5 public/index.html

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./public"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment summary
        run: |
          echo ""
          echo "ğŸ‰ Deployment completed!"
          echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "ğŸ“‹ Deployment checklist:"
          echo "   âœ… Repository scanned"
          echo "   âœ… Files detected and copied"
          echo "   âœ… Static site built"
          echo "   âœ… Uploaded to GitHub Pages"
          echo "   âœ… Site is now live!"
          echo ""
          echo "ğŸ”— Visit your GitHub Finder at the URL above!"
